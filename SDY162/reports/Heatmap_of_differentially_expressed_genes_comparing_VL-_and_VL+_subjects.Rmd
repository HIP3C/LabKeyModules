# Heatmap of differentially expressed genes in response to polyIC treatment
### Report generated by `r labkey.user.email`

```{r knitr-options, echo=FALSE, eval=TRUE, cache=FALSE}
library(knitr)
opts_knit$set(progress = TRUE, verbose = TRUE)
opts_chunk$set(cache=FALSE, echo=FALSE, eval=TRUE, message=FALSE, error=TRUE, dev="png", fig.width=10, fig.height=7, dpi=120, fig.align="center")
options(width=80)
```

```{r load-required-packages, cache=FALSE, echo=FALSE}
library(Biobase)
library(Rlabkey)
library(data.table)
library(pheatmap)
library(RColorBrewer)
library(limma)
```


## Summary

In this report, we generate a heatmap of differentially expressed genes detected by <a href="http://www.bioconductor.org/packages/2.12/bioc/html/limma.html" target="_blank">Limma</a> comparing before and after treatment with poly IC. This reports reproduces Figure 2 of <a href="http://www.ncbi.nlm.nih.gov/pubmed/23220997" target="_blank">Qian et al. (2013)</a>.
<br />

## Results

```{r global-options, cache=FALSE}
# Colorblind Safe palette for heatmaps
mypalette <- rev(brewer.pal(name="PiYG", n=11))
```

```{r read-analysis, cache=TRUE, cache.extra=digest::digest(labkey.data)}
gea <- labkey.data
```


```{r expression, cache=TRUE}
exMat <- labkey.selectRows(baseUrl =labkey.url.base, folderPath = labkey.url.path, schemaName = "study",queryName = "gene_expression_matrices", colFilter=makeFilter( c( 'expression_matrix_accession', 'IN', "EXPM0010") ), colNameOpt="rname")
exMatLink <- paste(labkey.file.root, "analysis/exprs_matrices", unique(exMat$file_info_name), sep="/")
exprs <- read.table(exMatLink)
```


```{r tmp-mapping, cache=TRUE, dependson="expression"}
map <- read.table(paste(labkey.file.root, "rawdata", "gene_expression", "geomap.tsv", sep="/"), sep="\t", header=TRUE)
colnames(map) <- tolower(colnames(map))
pdt <- data.table(exMat)
dtmap <- data.table(map)
setkey(pdt, biosample_accession)
setkey(dtmap, biosample_accession)
phenodata <- pdt[dtmap]
phenodata <- phenodata[match(colnames(exprs), biosample_accession),]
phenodata <- phenodata[celltype=="MACRO",]
phenodata <- data.frame(phenodata)
rownames(phenodata) <- phenodata[, "biosample_accession"]
```

```{r fdata, cache=TRUE, dependson="expression"}
fdLink <- paste(labkey.file.root, "analysis/features2genes", unique(exMat$feature_mapping_file), sep="/")
fdata <- read.table(fdLink, header = TRUE, sep = "\t")
```


```{r eset, cache=TRUE, dependson="read-analysis;expression;fdata;tmp-mapping"}
#gea <- gea[ gea$adj_p_val < 0.05 & abs(gea$log_fc) > log2(1.5),]
fdata <- fdata[na.omit(match(gea$feature_id, fdata$feature_id)), ]
exprs <- exprs[rownames(fdata), rownames(phenodata)]

eset <- ExpressionSet(assayData = as.matrix(exprs[,colnames(exprs) %in% phenodata$biosample_accession]), phenoData = as(phenodata, "AnnotatedDataFrame"), featureData = as(fdata, "AnnotatedDataFrame"))
eset <- eset[, order(eset$patientid, eset$trt)]
```

```{r FC, cache=TRUE, dependson='eset'}
FC <- exprs(eset[, seq(2, dim(eset)[2], 2)]) - exprs(eset[, seq(1, dim(eset)[2], 2)])
colnames(FC) <- pData(eset[, seq(1, dim(eset)[2], 2)])$subject_accession
```

```{r limma, cache=TRUE, dependson='FC;eset'}
PvalThresh <- 0.1
FDRthresh <- 0.05

hcv_status = pData(eset[, seq(1, dim(eset)[2], 2)])$hcv.status
mm <- model.matrix(~-1 + hcv_status)
colnames(mm) <- levels(hcv_status)
fit <- lmFit(FC, mm)
contrast.matrix <- makeContrasts(contrasts = "Neg-Pos", levels = mm)
fit2 <- contrasts.fit(fit, contrast.matrix)
ebay <- eBayes(fit2)
sstt <- topTable(ebay, coef = 1, number = Inf)
DE <- sstt[sstt$P.Value < PvalThresh, ]
DEfdr <- sstt[sstt$adj.P.Val < FDRthresh, ]
```





```{r plot-heatmap, cache=TRUE, dependson='limma'}
DEeset <- eset[rownames(DE),]
DEeset <- DEeset[ ,with(pData(DEeset), order(trt, subject_accession))]
heatmat <- exprs(DEeset)
colnames(heatmat) <- sampleNames(DEeset)

show_rownames = FALSE
if(nrow(heatmat)<100){
   rn <- as.character(fData(DEeset)$gene_symbol)
   head(nchar(rn))
   rn[rn==""] <- as.character(fData(DEeset)$feature_id)[ rn==""]
   rownames(heatmat) <- rn
   show_rownames <- TRUE
}

ann <- data.frame(HCV.status = DEeset$hcv.status, treatment = DEeset$trt, row.names=sampleNames(DEeset))
ann_col <- list(HCV.status= c(`Neg`="black", `Pos`="red"), treatment=c(`Mock`="yellow", `Poly IC H`="blue"))

maxVal <- max(abs(scale(t(heatmat))))
breaks <- seq( -maxVal, maxVal, length.out=length(mypalette))
pheatmap(heatmat, scale="row", color=mypalette, cluster_cols=FALSE, annotation=ann, annotation_colors=ann_col, show_colnames=FALSE, show_rownames=show_rownames, breaks=breaks)
```

Each probe is normalized separately so that the expression values across the samples have a mean of zero and a standard deviation of 1.
