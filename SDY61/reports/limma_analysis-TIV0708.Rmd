# Differential expression analysis in the TIV cohort 2007/2008

### Report generated by `r labkey.user.email`


This report creates list of differentially expressed genes comparing all available timepoints to baseline. 



```{r knitr-options, echo=FALSE, eval=TRUE, cache=FALSE}
library(knitr)
opts_knit$set(progress = TRUE, verbose = TRUE)
opts_chunk$set(cache=FALSE, echo=TRUE, eval=TRUE, message=FALSE, warning=TRUE, error=TRUE, dev="png", fig.width=6, fig.height=4, dpi=100, autodep=FALSE)
options(width=80)
```

```{r load-required-packages}
# Load required packages
library(Biobase)
library(limma)
library(Rlabkey)
library(data.table)
```

### Get the relevant expression matrix from the database.
```{r expression, cache=TRUE}
exMat <- labkey.selectRows(baseUrl = labkey.url.base, folderPath = labkey.url.path, schemaName = "study", queryName = "gene_expression_matrices", colFilter=makeFilter( c( 'expression_matrix_accession', 'IN', 'EXPM0003' ) ), colNameOpt="rname")
exMatLink <- paste(labkey.file.root, "analysis/exprs_matrices", unique(exMat$file_info_name), sep="/")
exprs <- read.table(exMatLink)
```

### Get the probe mapping file
```{r fdata, cache=TRUE, dependson="expression"}
fdLink <- paste(labkey.file.root, "analysis/features2genes", unique(exMat$feature_mapping_file), sep="/")
fdata <- read.table(fdLink, header=TRUE)
```

### Get the phenotypic data
```{r pdata, cache=TRUE, dependson="expression"}
rownames(exMat) <- exMat$biosample_accession
exMat$study_time_reported <- as.character(exMat$study_time_reported)
exMat <- exMat[na.omit(match(colnames(exprs), exMat$biosample_accession)),]
```

### Create an expressionSet
```{r eset, cache=TRUE, dependson="expression;fdata;pdata"}
fdata <- fdata[na.omit(match(rownames(exprs), fdata$feature_id)),]
eset <- ExpressionSet(assayData = as.matrix(exprs), phenoData = as(exMat, "AnnotatedDataFrame"), featureData = as(fdata, "AnnotatedDataFrame"))
```

### Differential expression analysis using limma
```{r limma, cache=TRUE, dependson="eset"}
FDRthresh <- 0.05
mm <- model.matrix(~subject_accession + study_time_reported, eset)
fit <- lmFit(eset, mm)
ebay <- eBayes(fit)
tt3 <- topTable(ebay, coef="study_time_reported3", number=Inf)
tt7 <- topTable(ebay, coef="study_time_reported7", number=Inf)
```

Using an FDR threshold of `r FDRthresh`, we detect `r sum(tt3$adj.P.Val < FDRthresh)` differentially expressed genes at d3 vs. d0 and `r sum(tt7$adj.P.Val < FDRthresh)` at d7 vs. d0. We can now write these files to disk as follows:

```{r save-results, cache=TRUE, dependson="limma"}
limma_table <- tt3[,c("feature_id", "gene_symbol", "logFC", "AveExpr", "t", "P.Value", "adj.P.Val")]
setnames(limma_table,c("logFC", "AveExpr", "t", "P.Value", "adj.P.Val"), c("log_fc", "ave_expr", "statistic", "p_value", "adj_p_val"))
limma_table$analysis_accession <- "GEA4"
write.table(limma_table, paste0(labkey.file.root,"/analysis/gene_expression_analysis/limma/limma_table_TIV_0708_D3vsD0.tsv"),sep="\t", quote=FALSE, row.names=FALSE)

limma_table <- tt7[,c("feature_id", "gene_symbol", "logFC", "AveExpr", "t", "P.Value", "adj.P.Val")]
setnames(limma_table,c("logFC", "AveExpr", "t", "P.Value", "adj.P.Val"), c("log_fc", "ave_expr", "statistic", "p_value", "adj_p_val"))
limma_table$analysis_accession <- "GEA3"
write.table(limma_table, paste0(labkey.file.root,"/analysis/gene_expression_analysis/limma/limma_table_TIV_0708_D7vsD0.tsv"),sep="\t", quote=FALSE, row.names=FALSE)
```
