# Differential expression analysis in the TIV cohort 2007/2008

### Report generated by `r labkey.user.email`


This report creates list of differentially expressed genes comparing all available timepoints to baseline. 



```{r knitr-options, echo=FALSE, eval=TRUE, cache=FALSE}
library(knitr)
opts_knit$set(progress = TRUE, verbose = TRUE)
opts_chunk$set(echo=TRUE, eval=TRUE, message=FALSE, warning=TRUE, error=TRUE, dev="png", fig.width=6, fig.height=4, dpi=100, autodep=FALSE)
opts_chunk$set(cache=FALSE, cache.path=paste(labkey.file.root, "cache/limma_analysis-TIV0708/", sep="/"))
options(width=80)
```

```{r load-required-packages}
# Load required packages
library(Biobase)
library(limma)
library(Rlabkey)
library(data.table)
```

### Get the relevant expression matrix from the database.
```{r expression, cache=TRUE}
GEM <- unique(labkey.selectRows(labkey.url.base, labkey.url.path, "assay.ExpressionMatrix.matrix",
                    "InputSamples", "gene_expression_matrices", colNameOpt = "rname"))
colnames(GEM) <- gsub("^biosample_", "", colnames(GEM))
file <- file.path(labkey.file.root, "analysis/exprs_matrices", unique(GEM$run_dataoutputs_name))
mat <- fread(file, header = TRUE)
setnames(mat, " ", "feature_id")
exprs <- as.matrix(mat[, grep("feature_id", colnames(mat), value = TRUE, invert = TRUE), with = FALSE])
rownames(exprs) <- mat[, feature_id]
```

### Get the phenotypic data
```{r pdata, cache=TRUE, dependson="expression"}
rownames(GEM) <- GEM$biosample_accession
GEM$study_time_collected <- as.character(GEM$study_time_collected)
GEM <- GEM[na.omit(match(colnames(exprs), GEM$biosample_accession)),]
```

### Create an expressionSet
```{r eset, cache=TRUE, dependson="expression;pdata"}
eset <- ExpressionSet(assayData = as.matrix(exprs), phenoData = as(GEM, "AnnotatedDataFrame"))
```

### Differential expression analysis using limma
```{r limma, cache=TRUE, dependson="eset"}
FDRthresh <- 0.05
mm <- model.matrix(~subject_accession + study_time_collected, eset)
fit <- lmFit(eset, mm)
ebay <- eBayes(fit)
tt3 <- topTable(ebay, coef="study_time_collected3", number=Inf)
tt7 <- topTable(ebay, coef="study_time_collected7", number=Inf)

analysis_accession <- c("GEA1", "GEA2")
description <- paste("Differential expression in TIV Group 2007 using limma, Day", c(3,7), "vs. Day0")
timepoint <- c(3,7)
newGEA <- data.frame(analysis_accession = analysis_accession, expression_matrix = unique(GEM$run_dataoutputs_name), timepoint = timepoint, description = description)
tt3$feature_id <- rownames(tt3)
tt3$analysis_accession <- newGEA[1, "analysis_accession"]
tt3$description <- newGEA[1, "description"]
tt7$feature_id <- rownames(tt7)
tt7$analysis_accession <-newGEA[2, "analysis_accession"]
tt7$description <- newGEA[2, "description"]
```

Using an FDR threshold of `r FDRthresh`, we detect `r sum(tt3$adj.P.Val < FDRthresh)` differentially expressed genes at d3 vs. d0 and `r sum(tt7$adj.P.Val < FDRthresh)` at d7 vs. d0. We can now save the results in the database:

```{r write-results, cache=TRUE, dependson="limma"}
newGEAR <- rbindlist(list(tt3, tt7))
newGEAR <- newGEAR[, list(analysis_accession, feature_id, logFC, AveExpr, t, P.Value, adj.P.Val)]
setnames(newGEAR, c("logFC", "AveExpr", "t", "P.Value", "adj.P.Val"), c("log_fc", "ave_expr", "statistic", "p_value", "adj_p_val"))

existGEA <- labkey.selectRows(labkey.url.base, labkey.url.path, "lists", "gene_expression_analysis", colNameOpt = "rname")
newGEA <- newGEA[!newGEA$analysis_accession %in% existGEA$analysis_accession,]
if(nrow(newGEA) > 0){
    res <- labkey.importRows(labkey.url.base, labkey.url.path, "lists", "gene_expression_analysis", toImport = newGEA)
}
print(newGEA)

newGEAR <- newGEAR[!analysis_accession %in% existGEA$analysis_accession]
if(nrow(newGEAR) > 0){
    res <- labkey.importRows(labkey.url.base, labkey.url.path, "lists", "gene_expression_analysis_results", toImport = newGEAR)
}
```
