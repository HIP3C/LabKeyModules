#---------------------------
# DEPENDENCIES
#----------------------------

library(Rlabkey)
library(ImmuneSpaceR)
library(flowWorkspace)
library(data.table)

#----------------------------
# FUNCTIONS
#----------------------------

.getGS <- function(ws, group_id_num = 1) {
    gs <- parseWorkspace(ws,
                         name = group_id_num,
                         subset = 1:20,
                         keywords = c("DAY", "TREATMENT", "TUBE NAME"),
                         isNCdf = TRUE,
                         additional.sampleID = TRUE) # this is a hidden option not exposed in parseWorkspace docs
    pData(gs)$FILENAME <- basename(as.character(keyword(gs, "FILENAME")$FILENAME))
    pData(gs)$panel <- unlist(lapply(gs@data@frames, function(x){
                                     markers <- markernames(x)
                                     paste(markers[markers != "-"], collapse = "|")
    }))[rownames(pData(gs))]
    return(gs)
}

.updateGuid <- function(gs, guid) {
    gs@guid <- guid
    return(gs)
}

.runData <- function(gs, group_id, group_name, wsid, ws, sdy) {
    workspace <- ws@file
    gating_set <- gs@guid
    group_id <- as.character(group_id)
    group_name <- as.character(group_name)
    num_samples <- length(gs@data@phenoData@data$name)
    num_unique_days <- length(unique(pData(gs)$DAY))
    num_unique_trt <- length(unique(pData(gs)$TREATMENT))
    num_unique_tube <- length(unique(pData(gs)$`TUBE NAME`))
    panels <- paste(unique(pData(gs)$panel), collapse = "; ")
    fw_version <- as.character(packageVersion("flowWorkspace"))
    study <- sdy
    created <- format(Sys.time(), "%b %d %X %Y")
    
    run <- data.frame(gating_set, workspace, wsid, group_id, group_name, num_samples, num_unique_days,
                      num_unique_trt, num_unique_tube, panels, fw_version, study, created)
    
    labkey.insertRows(baseUrl = labkey.url.base,
                      folderPath = labkey.url.path,
                      schemaName = "cytometry_processing",
                      queryName = "gatingSetMetaData",
                      toInsert = run)
}

.inputFiles <- function(gs, wsid, wsdir, labkey.url.base, labkey.url.path) {
    fcs <- pData(gs)$FILENAME
    input_files <- labkey.selectRows(baseUrl = labkey.url.base,
                                     folderPath = labkey.url.path,
                                     schemaName = "study",
                                     queryName = "fcs_sample_files",
                                     colNameOpt = "rname",
                                     colSelect = c("file_info_name", "ParticipantId", "biosample_accession", "expsample_accession", 
                                                   "study_accession"))
    input_files <- input_files[input_files$file_info_name %in% fcs, ]
    input_files$wsid <- wsid
    input_files$gating_set <- gs@guid
    input_files$gsdir <- paste0(wsdir,"/",gs@guid)
    labkey.insertRows(baseUrl = labkey.url.base,
                      folderPath = labkey.url.path,
                      schemaName = "cytometry_processing",
                      queryName = "gatingSetInputFiles",
                      toInsert = input_files)
}


#--------------------------
# PIPELINE
#--------------------------

runCreateGS <- function(labkey.url.base,
                        labkey.url.path,
                        pipeline.root,
                        data.directory,
                        analysis.directory,
                        protocol,
                        onCL = FALSE) {
    
    sdy <- gsub("/Studies/", "", labkey.url.path)
    wsid <- protocol

    ##---------------CHECK-FOR-FILES---------------##
    
    # check for workspace file in correct format (xml)
    ws_regex <- paste0(wsid, ".*xml$")
    ws_file <- list.files(data.directory, pattern = ws_regex, full.names = TRUE)

    if ( length(ws_file) == 0 ) {
        stop("No XML workspace files found")
    }
    
    # check the wsid is unique to a single workspace file
    if ( length(ws_file) > 1 ) {
        stop(paste0("More than one workspace found with ID: ", wsid))
    }

    # check that analysis directory exists
    if (!file.exists(analysis.directory)) {
        dir.create(analysis.directory, recursive = TRUE)
    }
    
    # create output directory
    outpath <- paste0(pipeline.root, "/analysis/gating_set/")    
    if (!file.exists(outpath)) {
        dir.create(outpath, recursive = TRUE)
    }
    
    # create gating set directory path
    # don't create directory yet...
    # for studies outputting gs using save_gslist wsdir should not exist
    # for studies outputting gs using save_gs wsdire must exist
    wsdir <- paste0(outpath, wsid) 
    
    ##---------------HARDCODED-METADATA---------------##
    # Manually curate a list to avoid hardcoding throughout
    metaData <- list()

    #*** RmGrp ***#
    # If a workspace requires a group to be removed add the logic here and log why
    # the group has been removed.

    # SDY113 - Group 3 - 885 controls
    # For this study controls were put in their own group as well as the other corrosponding
    # plate # group. Gating sets should not have overlapping samples. We remove Group 3 to handle this.

    rmGroup <- sdy %in% c("SDY113")
    
    if (sdy == "SDY113") {
            group <- 3  
    } else { 
        group <- NA 
    }

    metaData$rmGrp <- data.table(rmGroup = rmGroup, group = group)
    
    #*** xmlMod ***#
    # Some workspaces appear to have been generated by an uncommon version
    # of FlowJo. The prefix/suffix used in the xml need to be modified to
    # be compliant with parseWorkspace.
    
    metaData$xmlMod <- sdy %in% c("SDY372", "SDY301")


    ##---------------MODIFY-WORKSPACE-XML---------------##
    
    if (metaData$xmlMod) {
        con <- file(ws_file, "r")
        tm <- readLines(con = con)
        # remove prefix/suffix
        tm <- gsub("prefix=\"&lt;\" suffix=\"&gt;\"", "", tm)
        tm <- gsub("&lt;", "", tm)
        tm <- gsub("&gt;", "", tm)
                       
        # write out modified xml
        mod_xml <- paste0(ws_file, ".mod")
        writeLines(tm, mod_xml)
        
        # change ws_file variable to the modified xml
        ws_file <- mod_xml
    }

    ##---------------COMMAND-LINE-RUN-TASKS---------------##
    
    # if the ws is being rerun via the command line the rows in cytometry_processing.GatingSetInputFiles 
    # and assay.General.gatingset.Data need to be removed and repopulated. Also need to remove gating sets.
    if (onCL) {
        # delete inputfiles
        # get inputFiles row keys
        inputKeys <- labkey.selectRows(baseUrl = labkey.url.base,
                                        folderPath = labkey.url.path,
                                        schemaName = "cytometry_processing",
                                        queryName = "gatingSetInputFiles",
                                        #colSelect = c("key", "wsid"),
                                        showHidden = TRUE,
                                        colNameOpt = "rname")
        
        inputKeysToDelete <- subset(inputKeys, select=c(key, container))

        # delete InputFile rows
        inputKeysDeleted <- labkey.deleteRows(baseUrl = labkey.url.base,
                          folderPath = labkey.url.path,
                          schemaName = "cytometry_processing",
                          queryName = "gatingSetInputFiles",
                          toDelete = inputKeysToDelete)

        # delete gatingSets from previous run
        unlink(wsdir, recursive = TRUE)

        # get metaData rows to delete
        gsMetaData <- labkey.selectRows(baseUrl = labkey.url.base,
                                        folderPath = labkey.url.path,
                                        schemaName = "cytometry_processing",
                                        queryName = "gatingSetMetaData",
                                        colSelect = c("key", "wsid"),
                                        colNameOpt = "rname")

        # only remove rows from current wsid
        gsMetaDataToDelete <- labkey.selectRows(baseUrl = labkey.url.base,
                                                folderPath = labkey.url.path,
                                                schemaName = "cytometry_processing",
                                                queryName = "gatingSetMetaData",
                                                toDelete = gsMetaData)
    }



    ##---------------ACCESS-BASIC-WORKSPACE-INFO---------------##
    ws <- openWorkspace(ws_file)

    sample_groups <- getSampleGroups(ws)
    groups <- unique(sample_groups[, c("groupID", "groupName")])
    
    # assign group #
    groups$groupNumber <- seq(1:nrow(groups))
    
    # remove groups as needed
    if ( metaData$rmGrp$rmGroup ){
        groups <- groups[ -(metaData$rmGrp$group), ]
    }

    ##---------------PARSE-WS-AND-OUTPUT-GS---------------##
    if ( nrow(groups) == 1 ) {
        gs <- .getGS(ws)
        gs@guid <- paste0(sdy, "_", wsid, "_GS", groups$groupID)
        
        # check directories for save_gs to run
        if (!file.exists(wsdir)) {
            dir.create(wsdir, recursive = TRUE)
        }
        
        gsdir <- paste0(wsdir, "/", gs@guid)
        if (file.exists(gsdir)) {
            stop('gsdir exists -- must delete before proceeding')
        }
        
        
        run <- .runData(gs, groups$groupID, groups$groupName, wsid, ws, sdy)
        save_gs(gs,
                gsdir,
                cdf="copy")
        input <- .inputFiles(gs, wsid, gsdir, labkey.url.base, labkey.url.path)
        } else {
            # remove all samples
            groups <- subset(groups, groups$groupName != "All Samples")
            
            group_num <- groups$groupNumber
            group_id <- groups$groupID
            group_name <- groups$groupName

            gs_list <- lapply(group_num, function(num) {
                              .getGS(ws = ws, group_id_num = num)
            })

            guids <- paste0(sdy, "_", wsid, "_GS", group_id)
            gs_list <- mapply(.updateGuid, gs_list, guids)


            run <- mapply(.runData, gs_list, group_id, group_name, MoreArgs= list(wsid, ws, sdy), SIMPLIFY = FALSE)
            run <- data.table(do.call(rbind, run))
            
            save_gslist(GatingSetList(gs_list),
                        wsdir,
                        cdf="copy")            
            
            lapply(gs_list, function(gs) {
                   .inputFiles(gs, wsid, wsdir,  labkey.url.base, labkey.url.path)
            })

        }

    #--------------COPY-OVER-SCRIPT-FILES--------------##
    file.copy(from = "/share/github/LabKeyModules/HIPCCyto/pipeline/tasks/create-gatingset.R",
              to = paste0(analysis.directory, "/create-gatingset-snapshot.R"),
              overwrite = onCL)
    file.copy(from = "/share/github/LabKeyModules/HIPCCyto/pipeline/tasks/runCreateGS.R",
              to = paste0(analysis.directory, "/runGS-snapshot.R"),
              overwrite = onCL)


}
