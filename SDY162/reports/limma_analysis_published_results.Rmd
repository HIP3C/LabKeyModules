# Differential expression analysis after polyIC treatment in the VL+/- cohorts
## (Reproducing published results)

### Report generated by `r labkey.user.email`
```{r knitr-options, echo=FALSE, eval=TRUE, cache=FALSE}
library(knitr)
opts_chunk$set(echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, error=TRUE)
opts_chunk$set(cache=FALSE, cache.path=paste(labkey.file.root, "cache/limma_analysis_published_results/", sep="/"))
options(width=80)
```

```{r load-required-packages}
library(Biobase)
library(limma)
library(Rlabkey)
library(data.table)
library(pheatmap)
```


```{r expression, cache=TRUE}
#read gene_expression_files
exMat <- labkey.selectRows(baseUrl = labkey.url.base, folderPath = labkey.url.path,
      schemaName = "study", queryName = "gene_expression_matrices", colNameOpt = "rname")
exMatLink <- paste(labkey.file.root, "analysis/exprs_matrices", unique(exMat$file_info_name), sep="/")
exprs <- read.table(exMatLink)
```

### Get the probe mapping file
```{r fdata, cache=TRUE, dependson="expression"}
fdLink <- paste(labkey.file.root, "analysis/features2genes", unique(exMat$feature_mapping_file), sep="/")
fdata <- read.table(fdLink, header=TRUE, sep="\t")
```

### Get the phenotypic data
```{r pdata, cache=TRUE, dependson="expression"}
rownames(exMat) <- exMat$biosample_accession
exMat <- exMat[match(colnames(exprs), exMat$biosample_accession),]
```

```{r tmp-mapping}
map <- read.table(paste(labkey.file.root, "rawdata", "gene_expression", "geomap.tsv", sep="/"), sep="\t", header=TRUE)
pdt <- data.table(exMat)
dtmap <- data.table(map)
setkey(pdt, biosample_accession)
setkey(dtmap, biosample_accession)
phenodata <- pdt[dtmap]
phenodata <- phenodata[match(colnames(exprs), biosample_accession),]
phenodata <- data.frame(phenodata)
rownames(phenodata) <- phenodata[, "biosample_accession"]
```

## Create an expressionSet
```{r eset, cache=TRUE, dependson="expression;fdata;pdata"}
eset <- ExpressionSet(assayData = as.matrix(exprs), phenoData = as(phenodata, "AnnotatedDataFrame"), featureData = as(fdata, "AnnotatedDataFrame"))
```

```{r subset-data}
eset <- eset[ ,eset$CellType=="MACRO"]
```

## Differential expression analysis using limma:
```{r limma, cache=TRUE, dependson='eset'}
FDRthresh <- 0.05
FCthresh <- 1.5

eset$treatment <- droplevels(eset$Trt)
mm <- model.matrix(~treatment, eset)
fit <- lmFit(eset, mm)
ebay <- eBayes(fit)
tt <- topTable(ebay, coef = "treatmentPoly IC H", number = Inf)
DEProbes <- tt[tt$adj.P.Val < FDRthresh & abs(tt$logFC) > log2(FCthresh), ]
up <- DEProbes[DEProbes$logFC>0,]
down <- DEProbes[DEProbes$logFC<0,]

```
Using limma with an FDR cutoff of `r FDRthresh` and an absolute fold-change threshold of `r FCthresh`, we find `r nrow(up)` up- and `r nrow(down)` down-regulated probes.  

We can now write these files to disk as follows:
```{r save-results, cache=TRUE, dependson="limma", eval=TRUE}
limma_table <- tt[,c("feature_id", "gene_symbol", "logFC", "AveExpr", "t", "P.Value", "adj.P.Val")]
setnames(limma_table,c("logFC", "AveExpr", "t", "P.Value", "adj.P.Val"), c("log_fc", "ave_expr", "statistic", "p_value", "adj_p_val"))
limma_table$analysis_accession <- "GEA7"
write.table(limma_table, paste0(labkey.file.root, "/analysis/gene_expression_analysis/limma/limma_table_polyIC.tsv"), 
    sep = "\t", quote = FALSE, row.names = FALSE)
```
