<link rel="stylesheet" type="text/css" href="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

<style type="text/css">

#fw_container { width: 80%; margin: 0 auto; }
</style>



# Gene Set Enrichment Analysis using MSigDB's immunologic signatures

### Report generated by `r labkey.user.email`
## Summary

In this report, we perform a gene set enrichment analysis (GSEA) using the immune signatures of the <a href="http://www.broadinstitute.org/gsea/msigdb/index.jsp" target="_blank">Broad Molecular Signature DataBase</a> (MSigDB). The GSEA analysis is done using the <a href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3458527/" target="_blank">Camera method</a> implemented in the <a href="http://www.bioconductor.org/packages/2.12/bioc/html/limma.html" target="_blank">Limma</a> package. Camera tests whether a set of genes is highly ranked relative to other genes in terms of differential expression, accounting for inter-gene correlation.
<br />
<br />



```{r knitr-options, echo=FALSE, eval=TRUE, cache=FALSE}
library(knitr)
opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, error=TRUE, autodep=FALSE)
opts_chunk$set(cache=FALSE, cache.path=file.path(labkey.file.root, "cache/GSEA_TIV08/"))
options(width=80)
```

```{r load-required-packages, cache=FALSE, message = FALSE, echo = FALSE}
# Load required packages
library(Biobase)
library(limma)
library(Rlabkey)
library(data.table)
library(GSEABase)
library(hgu133plus2.db)
```

```{r create-eset, cache = TRUE, echo = FALSE}
GEM <- unique(data.table(labkey.selectRows(labkey.url.base, labkey.url.path, "assay.ExpressionMatrix.matrix",
                    "InputSamples", "gene_expression_matrices", colNameOpt = "rname")))
setnames(GEM, colnames(GEM), gsub("^biosample_", "", colnames(GEM)))
ucohort <- unique(GEM[, run_dataoutputs_name])

esetList <- vector("list", length(ucohort))
for(i in 1:length(ucohort)){
  curCohort <- ucohort[i]
  ssGEM <- data.frame(GEM[run_dataoutputs_name == curCohort])
  file <- file.path(labkey.file.root, "analysis/exprs_matrices", curCohort)
  out <- capture.output(mat <- fread(file, header = TRUE))
  setnames(mat, " ", "feature_id")
  exprs <- as.matrix(mat[, grep("feature_id", colnames(mat), value = TRUE, invert = TRUE), with = FALSE])
  rownames(exprs) <- mat[, feature_id]
  rownames(ssGEM) <- ssGEM$biosample_accession
  ssGEM$study_time_collected <- as.character(ssGEM$study_time_collected)
  ssGEM <- ssGEM[na.omit(match(colnames(exprs), ssGEM$biosample_accession)),]
  esetList[[i]] <- ExpressionSet(assayData = exprs, phenoData = as(ssGEM, "AnnotatedDataFrame"))
}
names(esetList) <- ucohort
```

```{r make-indices, cache = TRUE, echo = FALSE}
c7_sig <- readRDS(file=paste0(labkey.file.root, "/analysis/GSEA/c7.all.v4.0.symbols.rds"))
fas <- data.table(labkey.selectRows(baseUrl="https://www.immunespace.org", folderPath="/Studies/SDY269",
    schemaName="Microarray", queryName="FeatureAnnotation"))
setnames(fas, colnames(fas), tolower(gsub(" ", "_", colnames(fas))))
fas <- fas[!is.na(gene_symbol)]
# split by " /// " -> many to many
allgenes <- strsplit(fas$gene_symbol, " /// ")
reps <- sapply(allgenes, length)
allfeatures <- rep(fas$feature_id, reps)
fasM2M <- data.table( feature_id = allfeatures, gene_symbol = unlist(allgenes))

sets_indices <- lapply(c7_sig, function(x){ fasM2M[gene_symbol %in% geneIds(x), feature_id]})
names(sets_indices) <- names(c7_sig)
saveRDS(sets_indices, file=paste0(labkey.file.root, "/analysis/GSEA/sets_indices_TIV0809.rds"))
```

## LAIV 2008

```{r camera-LAIV, echo = FALSE, cache=TRUE, dependson="create-eset;make-indices"}
mm <- model.matrix(~subject_accession + study_time_collected, esetList[[1]])
res <- camera(esetList[[1]], sets_indices, design=mm, sort=FALSE)
res$PValue <- -10*log10(res$PValue)
setnames(res, "PValue", "p (-log10)")
res <- cbind(Signature=paste0('<a href="http://www.broadinstitute.org/gsea/msigdb/cards/',names(sets_indices),'.html" target="_blank">',names(sets_indices),"</a>"),res)
res <- res[order(res[,"p (-log10)"]),]
```

Using an FDR of 20%, `r sum(res$FDR<.2)` signatures would be called significant. The list of all signatures with FDR less than 20% is given in Table 1.
</br>
</br>

<div id="fw_container">

```{r kable-LAIV, results='asis', echo = FALSE, dependson="camera", htab.cap=TRUE, fig.cap="Table 1. List of significant immune signatures."}
kable(res[res$FDR<.2, ], format='html', row.names=FALSE, table.attr='id="res_table_LAIV08"')
```
</div>
<br>
<br>

## TIV 2008

```{r camera-TIV, echo = FALSE, cache=TRUE, dependson="create-eset;make-indices"}
mm <- model.matrix(~subject_accession + study_time_collected, esetList[[2]])
res <- camera(esetList[[2]], sets_indices, design=mm, sort=FALSE)
res$PValue <- -10*log10(res$PValue)
setnames(res, "PValue", "p (-log10)")
res <- cbind(Signature=paste0('<a href="http://www.broadinstitute.org/gsea/msigdb/cards/',names(sets_indices),'.html" target="_blank">',names(sets_indices),"</a>"),res)
res <- res[order(res[,"p (-log10)"]),]
```

Using an FDR of 20%, `r sum(res$FDR<.2)` signatures would be called significant. The list of all signatures with FDR less than 20% is given in Table 2.
</br>
</br>

<div id="fw_container">

```{r kable-TIV, results='asis', echo = FALSE, htab.cap=TRUE, fig.cap="Table 1. List of significant immune signatures."}
kable(res[res$FDR<.2, ], format='html', row.names=FALSE, table.attr='id="res_table_TIV08"')
```
</div>

<script type="text/javascript" charset="utf-8">
var init = function() {
  $(document).ready(function() {
    $('#res_table_TIV08').dataTable();
    $('#res_table_LAIV08').dataTable();
  });
}

LABKEY.requiresScript([
   'https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.min.js',
   'https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js'],
                      true, init, this, true);
</script>
