```{r knitr-opts, echo = FALSE}
library(knitr)
opts_chunk$set(message = FALSE, echo = FALSE, warning=FALSE)
opts_chunk$set(cache = FALSE, cache.path = file.path(labkey.file.root, "cache/GeneSetEnrichmentAnalysis/", labkey.user.email, ""))
```

```{r lib, cache = FALSE, message = FALSE, echo = FALSE, warning = FALSE}
library(ImmuneSpaceR)
library(ImmuneSpaceData)
library(Biobase)
library(limma)
library(pheatmap)
library(RColorBrewer)
library(reshape2)
library(gplots)
library(gtools)
library(data.table)
```

```{r param-caching, cache=TRUE, cache.extra=digest::digest(labkey.url.params), echo=FALSE}
```

```{r funcs, echo = FALSE, cache = TRUE}
msig_rnames <- function(rnames){
  rnames <- paste0('<a href="http://www.broadinstitute.org/gsea/msigdb/cards/',
                   rnames, '.html" target="_blank">', rnames, '</a>')
  return(rnames)
}
emory_rnames <- function(rnames){
  modules <- gsub("\\)$", "", gsub("^.*\\(", "", rnames))
  rnames <- paste0('<a href="http://www.interactivefigures.com/meni/btm416_annotation/btmdata/',
                   modules, '.htm" target="_blank">', rnames, '</a>')
  return(rnames)
}
baylor_rnames <- function(rnames){
  rnames <- paste0('<a href="http://www.biir.net/public_wikis/module_annotation/V2_Trial_8_Modules_',
                   rnames, '" target="_blank">', rnames, '</a>')
  return(rnames)
}
format_table <- function(x, ...){
  require(knitr)
  require(data.table)
  if(!is(x,"data.table"))
    {
    # This is to make sure that we don't have issues with row names in data.frames
    stop("This function only works on data.tables")
    }
  out <- kable(x, "html", table.attr = 'class="display" id="res_table_GSEA"', output = FALSE, ...)
  footer <- paste0("</thead>\n<tfoot>", strsplit(strsplit(out,"<thead>")[[1]][2],"</thead>")[[1]][1], "</tfoot>\n")
  out_new <- gsub("</thead>",footer,out)
  cat(out_new)
}
```

```{r params, cache = TRUE, dependson="param-caching"}
cohort <- labkey.url.params$cohort
set <- labkey.url.params$signature
#FDRthresh <- labkey.url.params$FDRthresh
study <- basename(labkey.url.path)
contrast <- "study_time_collected"
```

```{r prints, eval = FALSE}
print(labkey.url.params)
print(cohort)
print(set)
print(labkey.url.base)
print(labkey.url.path)
cat("labkey.file.root <- ",'"', labkey.file.root, '"', sep = "")
```

```{r modules, cache = TRUE, dependson="param-caching"}
switch(set,
          `MSigDB c7` = {data(msigdb_immunologic_signatures);
                         gene_sets <- msigdb_immunologic_signatures;
                         func_rnames <- msig_rnames},
          `Blood transcription` = {data(emory_blood_transcript_modules);
                                gene_sets <- emory_blood_transcript_modules;
                                func_rnames <- emory_rnames},
          `G2 (Trial 8) Modules` = {data(chaussabel_modules);
                      gene_sets <- chaussabel_modules;
                      func_rnames <- baylor_rnames})
```


```{r EM, cache = TRUE, dependson="params;funcs"}
con <- CreateConnection()
EM <- con$getGEMatrix(cohort = cohort, summary = TRUE)
```

```{r camera, cache = TRUE, dependson="EM;modules"}
indices <- ids2indices(gene_sets, fData(EM)$gene_symbol)
pData(EM)[, contrast] <- as.factor(pData(EM)[, contrast])
mm <- model.matrix(formula(paste("~subject_accession +", contrast)), EM)
colnames(mm) <- make.names(colnames(mm))
```

## Gene set enrichment analysis of `r cohort`

```{r byDay,  cache = TRUE, dependson="camera"}
lev <- levels(pData(EM)[, contrast])
lev_label <- paste0(contrast, lev[2:length(lev)])
lev <- make.names(lev_label)
cam_list <- vector('list', length = length(lev))
for(i in 1:length(lev)){
  contrasti <- lev[[i]]
    # Check if it's RNA-seq or microarrays
  if(max(exprs(EM))>100)
    res <- camera(voom(EM), index = indices, design = mm, contrast = makeContrasts(contrasti, levels=mm))
  else
    res <- camera(EM, index = indices, design = mm, contrast = makeContrasts(contrasti, levels=mm))

  dt <- data.table(res) 
  dt[, Module := rownames(res)]
  dt[, Coefficient := lev_label[[i]]]
  #dt[, PValue := 10*log10(PValue)]
  dt[, PValue := ifelse(Direction=="Up", -10*log10(PValue), 10*log10(PValue))]
  cam_list[[i]] <- dt
}
table <- rbindlist(cam_list)
setcolorder(table, c("Module", "Coefficient", "NGenes", "Correlation", "Direction", "PValue", "FDR"))
table <- table[order(abs(PValue), decreasing = TRUE)]
if(contrast == "study_time_collected"){
 table <- table[, Coefficient := gsub(contrast, "Day ", table[, Coefficient])]
 table <- table[mixedorder(Coefficient)]
}
```

```{r heatmap-matrix, cache = TRUE, dependson="byDay"}
PValThresh <- 30
#palette <- rev(brewer.pal(name="PiYG", n=11))
#palette <- rev(brewer.pal(name="RdPu", n=11))
palette <- colorpanel(20, low = "#268bd2", mid = "#fdf6e3", high = "#dc322f")
DEM <- unique(table[abs(PValue)>PValThresh, Module])
draw_heatmap <- FALSE
infostring <- ""
if(length(DEM) > 0){
  DEM <- table[Module %in% DEM, list(Module, Coefficient, PValue)]
  DEM <- dcast(DEM, formula = Module ~ Coefficient, value.var = "PValue")[, c("Module", mixedsort(unique(table$Coefficient)))]
  mat <- as.matrix(DEM[, -1])
  rownames(mat) <- DEM$Module
  draw_heatmap <- TRUE
} else{
  infostring <- "No gene set were found to be enriched."
}
```


```{r kable, cache = TRUE, dependson="byDay", results='asis', fig.heigth = 4, fig.width = 8}
#table <- table[, Module := func_rnames(Module)]
table <- table[, PValue := abs(PValue)]
setnames(table, "PValue", "10log10(p)")
format_table(table)
```

```{r pheatmap, cache=FALSE, dependson="heatmap-matrix"}
if(draw_heatmap){
  max <- max(abs(mat))
  if(nrow(mat) > 0){
    rownames(mat) <- ifelse(nchar(rownames(mat))>15, paste(substr(rownames(mat), 1, 8),
                     substr(rownames(mat), nchar(rownames(mat))-10, nchar(rownames(mat))), sep =" ... "),
                     rownames(mat))
    clust_rows <- ifelse(nrow(mat) < 2, FALSE, TRUE)
    pheatmap(mat, cluster_cols = FALSE, cluster_rows = clust_rows,
      breaks = seq(-max, max, length.out = length(palette)+1), color = palette)
  }
}
```


`r infostring`
