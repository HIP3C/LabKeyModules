## Creation of normalized expression matrices from raw data for all cohorts

### Report generated by `r labkey.user.email`

```{r knitr-opts, echo=FALSE}
library(knitr)
opts_chunk$set(message=FALSE)
opts_chunk$set(cache.path=paste(labkey.file.root, "cache/expression_matrix_creation/", sep="/"), cache=FALSE)
```

```{r libs, cache=FALSE}
library(data.table)
library(GEOquery)
library(Rlabkey)
```

```{r queries, cache=TRUE}
GEF <- data.table(labkey.selectRows(labkey.url.base, labkey.url.path, "study", "gene_expression_files", colNameOpt="rname"))
bs_filter <- makeFilter(c("biosample_accession", "IN", paste0(unique(GEF$biosample_accession), collapse=";")))

bs2es <- data.table(labkey.selectRows(labkey.url.base, labkey.url.path, "immport", "biosample_2_expsample", colFilter=bs_filter, colNameOpt="rname"))
es_filter <- makeFilter(c("expsample_accession", "IN", paste0(unique(bs2es$expsample_accession), collapse=";")))
es <- data.table(labkey.selectRows(labkey.url.base, labkey.url.path, "immport", "expsample", colFilter=es_filter, colNameOpt="rname"))

pdata <- merge(es, bs2es, by="expsample_accession")
pdata <- merge(pdata, GEF, by="biosample_accession")

serie <- gsub("\\..*", "", unique(GEF$file_info_name))
eset <- getGEO(serie)[[1]]
f2g <- data.table(fData(eset))
f2g <- f2g[, list(ID, Symbol)]
setnames(f2g, colnames(f2g), c("feature_id", "gene_symbol"))

pdata <- pdata[, list(biosample_accession, description.x, subject_accession, study_time_collected, arm_accession, arm_name)]
setnames(pdata, "description.x", "GEO")
```

```{r write-files}
for(arm in unique(pdata$arm_accession)){
  sspd <- pdata[arm_accession == arm]
  sspd <- sspd[ order(subject_accession, study_time_collected)]
  exprs <- data.table(exprs(eset)[, sspd$GEO])
  setnames(exprs, colnames(exprs), sspd[ match(colnames(exprs), GEO), biosample_accession])
  exprs <- exprs[, feature_id := rownames(exprs(eset))]
  matname <- tolower(paste0("exprs_matrix_", gsub("\\s", "_", unique(pdata[arm_accession==arm, arm_name])), ".tsv"))
  write.table(exprs, file=file.path(labkey.file.root, "analysis/exprs_matrices", matname), sep="\t", quote=FALSE, row.names=FALSE)
}
write.table(f2g, file=file.path(labkey.file.root, "analysis/features2genes", "HT12_V3.tsv"), row.names=FALSE)
```
