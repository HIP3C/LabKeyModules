
# Predicting HAI response from gene expression data
### Report generated by `r labkey.user.email`
## Summary

In this report, we use a penalized regression approach to select a set of genes that best predict HAI response in the TIV 2008/2009 cohort. The set of genes used (and all associated results) can be modified dynamically by filtering the input data in the grid view (data tab). The statistical procedure used here is the Elastic Net as implemented in the <a href="http://cran.r-project.org/web/packages/glmnet/index.html" target="_blank">glmnet package.</a> The prediction model is then tested on the TIV 2007/2008 cohort.
<br />
<br />

## Results
### Probe selection via the Elastic Net
```{r knitr-options, eval=TRUE, cache=FALSE}
library(knitr)
opts_knit$set(progress = TRUE, verbose = TRUE)
#opts_chunk$set(cache=TRUE, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, error=TRUE, dev="png", dev.args=list(bg="transparent"), out.width="900px", fig.width=10, fig.height=6, dpi=150, fig.align="center", autodep=TRUE, use.highlight=TRUE)
opts_chunk$set(cache=TRUE, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE, error=TRUE, fig.width=8, fig.height=4, dpi=100, fig.align="center")

options(width=80)

## Custom hooks to add caption to figures
knit_hooks$set(hfig.cap = function(before, options, envir) {
  if(!before & options$hfig.cap) {
    paste0('<div class="caption">',options$fig.cap,"</div>\n", sep="")
  }
})

## Custom hooks to add caption to figures
knit_hooks$set(htab.cap = function(before, options, envir) {
  if(before & options$htab.cap) {
    paste0('<div class="caption">',options$fig.cap,"</div>", sep="")
 } else if(options$htab.cap) {
    paste0("\n\n")
 }
})
```


```{r load-required-packages, cache=FALSE, results="hide", message=FALSE}
# Required librairies
library(ggplot2)
library(reshape2)
library(data.table)
library(RColorBrewer)
library(Rlabkey)
library(Biobase)
library(pheatmap)
library(glmnet)
```

```{r global-options}
mypalette <- rev(brewer.pal(name="PiYG", n=11))
brewer.qual <- "Paired"
IS_theme <- theme_bw(base_size=14)
```

```{r filter-probes, cache=TRUE, cache.extra=digest::digest(labkey.data)}
dt_probes <- data.table(labkey.data)
probes_selected <- unique(dt_probes[,feature_id]) 
```

The model selection is based on `r length(unique(probes_selected))` selected probes. Optimal parameters for the Elastic Net are selected via cross-validation.
The best predictive probes are summarized in Table 1, along with t-values and p-values calculated by fitting a multivariate linear model with the selected probes.

```{r expression, cache=TRUE}
exMat <- labkey.selectRows(baseUrl = labkey.url.base, folderPath = labkey.url.path, schemaName = "study", queryName = "gene_expression_matrices", colNameOpt="rname")
exMat <- data.table(exMat)
exMat <- exMat[,keep:=(sum(study_time_reported%in%c(0,3))==2),by="biosample_accession_name,subject_accession"]
exMat <- exMat[keep==TRUE]

exMat07 <- data.frame(exMat[matrix_description_description%like%"TIV" & matrix_description_description%like%"2007"])
exMat08 <- data.frame(exMat[matrix_description_description%like%"TIV" & matrix_description_description%like%"2009"])

exprs07 <- read.table(paste(labkey.file.root, "analysis", "exprs_matrices", unique(exMat07$file_info_name), sep="/"))
exprs08 <- read.table(paste(labkey.file.root, "analysis", "exprs_matrices", unique(exMat08$file_info_name), sep="/"))
```

```{r fdata, cache=TRUE, dependson="expression"}
#fdLink <- gsub("_webdav@files", labkey.file.root, gsub(labkey.url.path,  "", gsub(labkey.url.base,  "", URLdecode(unique(exMat$feature_mapping_file_link_download_link)))))
#fdata <- read.table(fdLink, header=TRUE)

fdata <- read.table(paste(labkey.file.root, "analysis", "features2genes", unique(exMat$feature_mapping_file), sep="/"))
fdata07 <- fdata[na.omit(match(rownames(exprs07), fdata$feature_id)), ]
fdata08 <- fdata[na.omit(match(rownames(exprs08), fdata$feature_id)), ]
```

```{r pdata, cache=TRUE, dependson="expression"}
# Query expression matrix
rownames(exMat07) <- exMat07$biosample_accession
exMat07$study_time_reported <- as.character(exMat07$study_time_reported)
exMat07 <- exMat07[na.omit(match(colnames(exprs07), exMat07$biosample_accession)),]
rownames(exMat08) <- exMat08$biosample_accession
exMat08$study_time_reported <- as.character(exMat08$study_time_reported)
exMat08 <- exMat08[na.omit(match(colnames(exprs08), exMat08$biosample_accession)),]
```

```{r eset, cache=TRUE, dependson="expression;fdata;pdata"}
exprs07 <- exprs07[, rownames(exMat07)]
eset_07 <- ExpressionSet(assayData = as.matrix(exprs07), phenoData = as(exMat07, "AnnotatedDataFrame"), featureData = as(fdata07, "AnnotatedDataFrame"))
exprs08 <- exprs08[, rownames(exMat08)]
eset_08 <- ExpressionSet(assayData = as.matrix(exprs08), phenoData = as(exMat08, "AnnotatedDataFrame"), featureData = as(fdata08, "AnnotatedDataFrame"))
```

```{r logFC, cache=TRUE, dependson='eset'}
## Compute the log fold-change
E <- exprs(eset_07)
st <- eset_07$study_time_reported

## Average the 3 and 7 time points
lFC_07 <- E[,st==3] - E[,st==0]

E <- exprs(eset_08)
st <- eset_08$study_time_reported
lFC_08 <- E[,st==3] - E[,st==0]
```

```{r hai, cache=TRUE, dependson='filter-probes;phenodata'}
ds_hai <- labkey.selectRows(baseUrl=labkey.url.base, schemaName="study", folderPath=labkey.url.path, queryName ="hai", colNameOpt='rname')
dt_hai <- data.table(ds_hai)

# Fold change over 28, and max response over strains
dt_hai <- dt_hai[,list(study_time_collected=study_time_collected, hai_response=value_reported/value_reported[study_time_collected==0]),by="virus_strain,biosample_accession_name,subject_accession"]
dt_hai <- dt_hai[study_time_collected==28]
dt_hai <- dt_hai[,list(hai_response=max(hai_response)),by="biosample_accession_name,subject_accession"]

## Sort by subject_accession
setkey(dt_hai,"subject_accession")

# Add responder information
dt_hai <- dt_hai[,responder:=ifelse(hai_response<=2, "Low", ifelse(hai_response>=4, "High", "Medium"))]
dt_hai_07 <- dt_hai[subject_accession%in%unique(exMat07$subject_accession) & biosample_accession_name%like%"2007"]
dt_hai_08 <- dt_hai[subject_accession%in%unique(exMat08$subject_accession) & biosample_accession_name%like%"2008"]
```

```{r rename-columns}
colnames(lFC_07) <- unique(exMat07$subject_accession)
colnames(lFC_08) <- unique(exMat08$subject_accession)
```

```{r hai-feature-selection, cache=TRUE, dependson="hai;logFC;filter-probes", fig.keep="none"}
# Filter the data based on correlation
x <- t(lFC_08[rownames(lFC_08)%in%probes_selected,])
y <- log2(dt_hai_08$hai_response)

#fit_hai_tiv08 <- glmnet(x, y, alpha=.5)
alphavalue <- as.numeric(labkey.url.params$paramValue)
fit_hai_tiv08 <- glmnet(x, y, alpha=alphavalue)
plot(fit_hai_tiv08, col=brewer.pal(name="Paired",n=11))
```
```{r hai-prediction-cv, cache=TRUE, dependson="hai-feature-selection", fig.keep="none"}
# Cross validation
cv_fit_hai_tiv08 <- cv.glmnet(x, y)
plot(cv_fit_hai_tiv08)
```

```{r hai-prediction-variable, results='asis', cache=TRUE, dependson="hai-prediction-cv"}
coef_hai_tiv08 <- predict(fit_hai_tiv08, s=cv_fit_hai_tiv08$lambda.min, type="coefficients")

# Selected features
selected_probes <- fdata08[fdata08$feature_id%in%rownames(coef_hai_tiv08)[coef_hai_tiv08[,1]>0],,drop=FALSE]

# If the user selected less variables than observations, no selection is done
if(length(probes_selected)<nrow(dt_hai_08)) {
      x.selected <- x
      selected_probes <- fdata08[fdata08$feature_id%in%probes_selected,]
 } else {
      x.selected <- x[,colnames(x)%in%selected_probes$feature_id,drop=FALSE]
 }

if(nrow(selected_probes)<2)
   {
   opts_chunk$set(eval=FALSE, cache=FALSE)
   stop("No probes were selected as predictive. You may try to change the filtering criteria.")
   }

relasso <- lm(y~x.selected)
sum_relasso <- summary(relasso)
sum_relasso_coef <- sum_relasso$coefficients
predictor_table <- cbind(selected_probes, sum_relasso_coef[,c("t value","Pr(>|t|)")][-1,])
setnames(predictor_table, c("t value","Pr(>|t|)"), c("t-value","p-value"))
```

<br/>
<br/>
   
<div id="fw_container">
```{r table-of-selected-probes, results='asis', cache=TRUE, dependson="hai-prediction-variable", htab.cap=TRUE, fig.cap="Table 1. Table of selected probes by the Elastic Net."}
predictor_table[,"gene_symbol"] <- paste0('<a href="http://www.genenames.org/cgi-bin/quick_search.pl?.cgifields=type&type=equal&num=50&search=', gsub(";","+",predictor_table[,"gene_symbol"]),'&submit=Submit" target="_blank">', predictor_table[,"gene_symbol"], '</a>')

kable(predictor_table, digits=2, format="html", row.names=FALSE, table.attr='id="res_table"')
```
</div>

<br />
<br />
   
<h3> Heatmap of selected probes </h3>

Figure 1 shows a heatmap of selected genes in the TIV 2008/2009 cohort.


```{r pheatmap-selected-probes, cache=TRUE, dependson="hai-prediction-variable", hfig.cap=TRUE, fig.cap="Figure 1. Heatmap of selected probes with HAI status annotation."}
annotation <- data.frame(hai=log2(dt_hai_08[,hai_response])) 
rownames(annotation) <- colnames(lFC_08)
mat <- lFC_08[predictor_table$feature_id, order(annotation$hai)]
# rownames(mat) <- paste(predictor_table$feature_id, " (", predictor_table$gene_symbol, ")",sep="")
pheatmap(mat, dendrogram="none", cluster_cols=FALSE, cluster_rows=TRUE, breaks = seq(-1, 1, length.out = length(mypalette) + 1), show_rownames=TRUE, show_colnames=FALSE, scale="none",cluster_method="ward",cluster_distance="correlation",color=mypalette, annotation=annotation, annotation_colors=list(hai=grey(10:0/10)))
```
<br />

### Prediction on training and test sets

```{r hai-predicted-TIV07, cache=TRUE, dependson="hai-prediction-variable"}
x.test <- data.frame(t(lFC_07[selected_probes$feature_id, ]), check.names=FALSE)
hai_predicted_tiv07 <- as.matrix(x.test)%*%as.vector((coef(relasso)[-1]))+coef(relasso)[1]
```
Figure 2 shows the predicted values vs the observed values for both TIV cohorts. The correlation between the predicted and observed values in the 2008/2009 cohort is `r cor(dt_hai_08$hai_response, relasso$fitted.values)` and `r cor(dt_hai_07$hai_response, hai_predicted_tiv07)` in the 2007/2008 cohort.

```{r hai-prediction-fitted, cache=TRUE, dependson="hai-prediction-variable;hai-predicted-TIV07", hfig.cap=TRUE, fig.cap="Figure 2. Predicted vs. observed values for the prediction model."}
df <- data.frame(observed=c(dt_hai_08$hai_response, dt_hai_07$hai_response), fitted=c(relasso$fitted.values, hai_predicted_tiv07), cohort=c(rep("a) TIV 08 (Training)", length(dt_hai_08$hai_response)), rep("b) TIV 07 (Test)",length(dt_hai_07$hai_response))))
ggplot(df, aes(x=log2(observed),y=fitted))+geom_point()+geom_smooth(method="lm")+IS_theme+facet_wrap(~cohort, scale="free") + xlab("Observed (log2) HAI response") + ylab("Predicted (log2) HAI response")
```

