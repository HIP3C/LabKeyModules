<link rel="stylesheet" type="text/css" href="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

<style type="text/css">

#fw_container { width: 80%; margin: 0 auto; }

.caption {
   font-weight:bold;
   font-size:100%;
   text-align:center;
}

</style>



# Gene Set Enrichment Analysis using MSigDB's immunologic signatures

### Report generated by `r labkey.user.email`
## Summary

In this report, we perform a gene set enrichment analysis (GSEA) using the immune signatures of the <a href="http://www.broadinstitute.org/gsea/msigdb/index.jsp" target="_blank">Broad Molecular Signature DataBase</a> (MSigDB). The GSEA analysis is done using the <a href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3458527/" target="_blank">Camera method</a> implemented in the <a href="http://www.bioconductor.org/packages/2.12/bioc/html/limma.html" target="_blank">Limma</a> package. Camera tests whether a set of genes is highly ranked relative to other genes in terms of differential expression, accounting for inter-gene correlation.
<br />
<br />

## Results

```{r knitr-options, echo=FALSE, eval=TRUE, cache=FALSE}
library(knitr)
opts_knit$set(progress = TRUE, verbose = TRUE)
opts_chunk$set(echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE, error=TRUE, dev="png", fig.width=6, fig.height=5, dpi=100, autodep=FALSE)
opts_chunk$set(cache=FALSE, cache.path=paste(labkey.file.root, "GSEA_TIV07/", sep="/"))
options(width=80)
```

```{r load-required-packages, cache=FALSE}
# Load required packages
library(Biobase)
library(limma)
library(Rlabkey)
library(data.table)
library(GSEABase)
library(hgu133plus2.db)
library(pheatmap)
library(RColorBrewer)
```
   
   
### Get the relevant expression matrix from the database.
```{r expression}
GEM <- unique(labkey.selectRows(labkey.url.base, labkey.url.path, "assay.ExpressionMatrix.matrix",
                    "InputSamples", "gene_expression_matrices", colNameOpt = "rname"))
colnames(GEM) <- gsub("^biosample_", "", colnames(GEM))
file <- file.path(labkey.file.root, "analysis/exprs_matrices", unique(GEM$run_dataoutputs_name))
mat <- fread(file, header = TRUE)
setnames(mat, " ", "feature_id")
exprs <- as.matrix(mat[, grep("feature_id", colnames(mat), value = TRUE, invert = TRUE), with = FALSE])
rownames(exprs) <- mat[, feature_id]

rownames(GEM) <- GEM$biosample_accession
GEM$study_time_collected <- as.character(GEM$study_time_collected)
GEM <- GEM[na.omit(match(colnames(exprs), GEM$biosample_accession)),]

fd <- data.frame(feature_id = rownames(exprs), row.names = rownames(exprs))
eset <- ExpressionSet(assayData = as.matrix(exprs), phenoData = as(GEM, "AnnotatedDataFrame"), featureData = as(fd, "AnnotatedDataFrame"))
```


```{r read-gmt-file, eval=FALSE}
c7_sig <- readRDS(file = file.path(labkey.file.root, "/analysis/GSEA/c7.all.v4.0.symbols.rds"))
sets_indices <- lapply(c7_sig, function(x,db,probeids){which(probeids%in%select(db, keys=geneIds(x), cols=c("PROBEID"), keytype="SYMBOL")$PROBEID)}, db=hgu133plus2.db, probeids=rownames(fData(eset)))
names(sets_indices) <- names(c7_sig)
saveRDS(sets_indices, file=paste0(labkey.file.root, "/analysis/GSEA/sets_indices_TIV0708.rds"))
```
   
```{r load-sets-indices,eval=TRUE}
sets_indices <- readRDS(paste0(labkey.file.root, "/analysis/GSEA/sets_indices_TIV0708.rds"))
```
```{r camera, eval=TRUE, dependson="eset;read-gmt-file"}
mm <- model.matrix(~subject_accession + study_time_collected, eset)
res <- camera(eset, sets_indices, design=mm, sort=FALSE)
res$PValue <- -10*log10(res$PValue)
setnames(res, "PValue", "p (-log10)")
res <- cbind(Signature=paste0('<a href="http://www.broadinstitute.org/gsea/msigdb/cards/',names(sets_indices),'.html" target="_blank">',names(sets_indices),"</a>"),res)
res <- res[order(res[,"p (-log10)"]),]
```

Using an FDR of 20%, `r sum(res$FDR<.2)` signatures would be called significant. The list of all signatures with FDR less than 20% is given in Table 1. 
</br>
</br>

<div id="fw_container">
```{r print-table, results='asis', eval=TRUE, echo=FALSE, dependson="camera", htab.cap=TRUE, fig.cap="Table 1. List of significant immune signatures."}
kable(res[res$FDR<.2, ], format='html', row.names=FALSE, table.attr='id="res_table"')
```
</div>
   
<script type="text/javascript" charset="utf-8">
var init = function() {
$(document).ready(function() {

$('#res_table').dataTable();
} );
//hljs.initHighlighting();
}

LABKEY.requiresScript([
   'https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.min.js',
   'https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js'], 
                      true, init, this, true);
</script>
