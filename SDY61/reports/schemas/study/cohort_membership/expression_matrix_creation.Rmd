# Creation of normalized expression matrices from raw data for all cohorts

### Report generated by `r labkey.user.email`

```{r knitr-options, echo=FALSE, eval=TRUE, cache=FALSE}
library(knitr)
opts_chunk$set(echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, error=TRUE, dev="png", fig.width=6, fig.height=5, dpi=100, autodep=FALSE)
opts_chunk$set(cache.path=paste(labkey.file.root, "cache/expression_matrix_creation/", sep="/"), cache=TRUE)
options(width=80)
```

```{r load-required-packages, cache=FALSE}
library(data.table)
library(Rlabkey)
library(affy)
library(annotate)
library(hgu133plus2.db)
```

```{r GE-files}
ds_GE_files <- labkey.selectRows(baseUrl=labkey.url.base, folderPath=labkey.url.path, schemaName="study", queryName="gene_expression_files", colNameOpt='rname')
dt_GE_files <- as.data.table(ds_GE_files)
dt_GE_files <- dt_GE_files[subtype=="PBMC"]
```

```{r phenodata, dependson="GE-files"}
# pd <- d_GE_files[file_info_name%like%"GSM.*.CEL", c("subject_accession", "study_time_collected", "biosample_accession", "file_info_name", "reagent_accession", "biosample_name"),with=FALSE]
pd <- dt_GE_files[file_info_name%like%"GSM.*.CEL"]
pd_LAIV_08 <- pd[biosample_name%like%"LAIV.*2008"]
pd_TIV_08 <- pd[biosample_name%like%"TIV.*2008"]
pd_TIV_07 <- pd[biosample_name%like%"TIV.*2007"]
pd_LAIV_08 <- as.data.frame(pd_LAIV_08)
rownames(pd_LAIV_08) <- pd_LAIV_08$biosample_accession
pd_TIV_08 <- as.data.frame(pd_TIV_08)
rownames(pd_TIV_08) <- pd_TIV_08$biosample_accession
pd_TIV_07 <- as.data.frame(pd_TIV_07)
rownames(pd_TIV_07) <- pd_TIV_07$biosample_accession
```

```{r get-gene-symbols-func}
get_symbols <- function(features, annotation=hgu133plus2.db){
   fdt <- data.table(select(annotation, keys=features, cols=c("SYMBOL","GENENAME"), keytype="PROBEID"))
   fdt <- fdt[, list(SYMBOL=paste(SYMBOL, collapse=";")), by=list(PROBEID)]
   fdt$SYMBOL
}

## TIV 2007/2008
```{r TIV07, dependson="phenodata"}
affybatch <- ReadAffy(filenames=paste(labkey.file.root, "rawdata", "gene_expression", pd_TIV_07$file_info_name, sep="/"))
eset_TIV_07 <- rma(affybatch)
sampleNames(eset_TIV_07) <- pd_TIV_07[ match(sampleNames(eset_TIV_07), pd_TIV_07$file_info_name), "biosample_accession"]
pData(eset_TIV_07) <- pd_TIV_07[match(rownames(pData(eset_TIV_07)), rownames(pd_TIV_07)),]
#fData(eset_TIV_07)$gene_symbol <- getSYMBOL(featureNames(eset_TIV_07), affybatch@annotation)
fData(eset_TIV_07)$gene_symbol <- get_symbols(featureNames(eset_TIV_07)) 
```

## TIV 2008/2009
```{r TIV08, dependson="phenodata"}
affybatch <- ReadAffy(filenames=paste(labkey.file.root, "rawdata", "gene_expression", pd_TIV_08$file_info_name, sep="/"))
eset_TIV_08 <- rma(affybatch)
sampleNames(eset_TIV_08) <- pd_TIV_08[ match(sampleNames(eset_TIV_08), pd_TIV_08$file_info_name), "biosample_accession"]
pData(eset_TIV_08) <- pd_TIV_08[match(rownames(pData(eset_TIV_08)), rownames(pd_TIV_08)),]
featureNames(eset_TIV_08) <- gsub("_PM", "", featureNames(eset_TIV_08))
#fData(eset_TIV_08)$gene_symbol <- getSYMBOL(featureNames(eset_TIV_08), "hgu133plus2")
#fdt <- data.table(select(hgu133plus2.db, keys=featureNames(eset_TIV_08), cols=c("SYMBOL","GENENAME"), keytype="PROBEID"))
#fdt <- fdt[, list(SYMBOL=paste(SYMBOL, collapse=";")), by=list(PROBEID)]
fData(eset_TIV_08)$gene_symbol <- get_symbols(featureNames(eset_TIV_08))
```

## LAIV 2008/2009
```{r LAIV08, dependson="phenodata"}
affybatch <- ReadAffy(filenames=paste(labkey.file.root, "rawdata", "gene_expression", pd_LAIV_08$file_info_name, sep="/"))
eset_LAIV_08 <- rma(affybatch)
sampleNames(eset_LAIV_08) <- pd_LAIV_08[ match(sampleNames(eset_LAIV_08), pd_LAIV_08$file_info_name), "biosample_accession"]
pData(eset_LAIV_08) <- pd_LAIV_08[match(rownames(pData(eset_LAIV_08)), rownames(pd_LAIV_08)),]
featureNames(eset_LAIV_08) <- gsub("_PM", "", featureNames(eset_LAIV_08))
#fData(eset_LAIV_08)$gene_symbol <- getSYMBOL(featureNames(eset_LAIV_08), "hgu133plus2")                      
fData(eset_LAIV_08)$gene_symbol <- get_symbols(featureNames(eset_LAIV_08))
```

## features_2_genes_HG_U133
```{r feature-2-gene, dependson="TIV08"}
f2g <- fData(eset_TIV_08)
f2g$feature_id <- rownames(f2g)
```

## Store the expression matrices in the file system
```{r write-to-labkey, dependson="LAIV08;TIV07;TIV08;feature-2-gene"}
write.table(exprs(eset_TIV_07), file=paste(labkey.file.root, "analysis", "exprs_matrices", "exprs_matrix_TIV_0708.tsv", sep="/"), sep="\t", quote=FALSE)
write.table(exprs(eset_TIV_08), file=paste(labkey.file.root, "analysis", "exprs_matrices", "exprs_matrix_TIV_0809.tsv", sep="/"), sep="\t", quote=FALSE)
write.table(exprs(eset_LAIV_08), file=paste(labkey.file.root, "analysis", "exprs_matrices", "exprs_matrix_LAIV_0809.tsv", sep="/"), sep="\t", quote=FALSE)
write.table(f2g, file=paste(labkey.file.root, "analysis", "features2genes", "features_2_genes_HG_U133.tsv", sep="/"), sep="\t", quote=FALSE)
```
